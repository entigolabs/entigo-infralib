name: Platform APIs RC Test

on:
  push:
    branches:
      - platform-apis-tests
    paths:
      - 'modules/k8s/platform-apis/**'
  pull_request:
    paths:
      - 'modules/k8s/platform-apis/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  test_platform_apis_rc:
    name: Test Platform APIs RC
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Modify RC package with suffix
      run: |
        set -e

        RC_PKG=$(ls modules/k8s/platform-apis/charts/platform-apis-*.tgz 2>/dev/null | head -1)
        [[ -z "$RC_PKG" ]] && echo "No RC package found" && exit 1

        VERSION=$(basename "$RC_PKG" .tgz | sed 's/platform-apis-//')
        SUFFIX=$(echo "$VERSION" | grep -oE 'rc\.[a-z0-9]+' | tr '.' '-')
        [[ -z "$SUFFIX" ]] && SUFFIX="rc-test"

        echo "VERSION=$VERSION SUFFIX=$SUFFIX"
        echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV

        # Extract package
        mkdir -p /tmp/chart-work
        tar -xzf "$RC_PKG" -C /tmp/chart-work

        # Add suffix to chart name
        sed -i "s/^name: platform-apis$/name: platform-apis-${SUFFIX}/" /tmp/chart-work/platform-apis/Chart.yaml

        # Add suffix to all resource names in templates
        for tpl in /tmp/chart-work/platform-apis/templates/*.yaml; do
          sed -i "s/name: platform-apis/name: platform-apis-${SUFFIX}/g" "$tpl"
        done

        # Repackage
        tar -czf "$RC_PKG" -C /tmp/chart-work platform-apis/

        # Update wrapper Chart.yaml dependency name
        sed -i "s/name: platform-apis$/name: platform-apis-${SUFFIX}/" modules/k8s/platform-apis/Chart.yaml

        # Update values.yaml key if exists
        [[ -f modules/k8s/platform-apis/values.yaml ]] && \
          sed -i "s/^platform-apis:/platform-apis-${SUFFIX}:/" modules/k8s/platform-apis/values.yaml

        # Update test configs
        for cfg in modules/k8s/platform-apis/test/aws_*.yaml; do
          sed -i "s/^platform-apis:/platform-apis-${SUFFIX}:/" "$cfg"
        done

        rm -rf /tmp/chart-work

    - name: Run tests
      env:
        PR_BRANCH: ${{ github.head_ref || github.ref_name }}
        ENTIGO_INFRALIB_DESTROY: true
      run: modules/k8s/platform-apis/test.sh

#    - name: Cleanup
#      if: always()
#      run: |
#        # Skip cleanup if SUFFIX is not set
#        if [[ -z "${SUFFIX}" ]]; then
#          echo "Skipping cleanup: SUFFIX not set"
#          exit 0
#        fi
#
#        echo "Cleaning up resources with suffix: ${SUFFIX}"
#
#        for cluster in pri-infra-eks biz-infra-eks; do
#          aws eks update-kubeconfig --region $AWS_REGION --name $cluster 2>/dev/null || continue
#          echo "Connected to $cluster"

#          # Delete ArgoCD apps with suffix
#          for ns in argocd-pri argocd-biz; do
#            kubectl get applications -n $ns -o name 2>/dev/null | grep -F "${SUFFIX}" | \
#              xargs -r kubectl delete -n $ns --wait=false 2>/dev/null || true
#          done

#          # Delete namespaces with suffix
#          kubectl get ns -o name 2>/dev/null | grep -F "${SUFFIX}" | \
#            xargs -r kubectl delete --wait=false 2>/dev/null || true

#          # Delete Helm releases with suffix
#          for ns in $(kubectl get ns -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
#            helm list -n $ns -q 2>/dev/null | grep -F "${SUFFIX}" | \
#              xargs -r -I{} helm uninstall {} -n $ns 2>/dev/null || true
#          done
#        done

#        # Cleanup local files
#        [[ -n "${MODULE_DIR}" ]] && rm -rf "${MODULE_DIR}"
#        rm -rf /tmp/chart-work

#        echo "Cleanup completed"