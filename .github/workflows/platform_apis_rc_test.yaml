name: Platform APIs RC Test

on:
  push:
    branches: [platform-apis-tests]
    paths: ['modules/k8s/platform-apis/**']
  pull_request:
    paths: ['modules/k8s/platform-apis/**']
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  test_platform_apis_rc:
    name: Test Platform APIs RC
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup RC test module
      run: |
        set -e

        RC_PKG=$(ls modules/k8s/platform-apis/charts/platform-apis-*.tgz 2>/dev/null | head -1)
        [[ -z "$RC_PKG" ]] && echo "No RC package found" && exit 1

        VERSION=$(basename "$RC_PKG" .tgz | sed 's/platform-apis-//')
        SUFFIX=$(echo "$VERSION" | grep -oE 'rc\.[a-z0-9]+' | tr '.' '-')
        [[ -z "$SUFFIX" ]] && SUFFIX="rc-test"

        NEW_MODULE="platform-apis-${SUFFIX}"
        MODULE_DIR="modules/k8s/${NEW_MODULE}"

        echo "VERSION=$VERSION SUFFIX=$SUFFIX NEW_MODULE=$NEW_MODULE"
        echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV
        echo "MODULE_DIR=${MODULE_DIR}" >> $GITHUB_ENV

        # Copy module to new directory
        cp -r modules/k8s/platform-apis "$MODULE_DIR"

        # Remove Chart.lock to avoid dependency conflicts
        rm -f "${MODULE_DIR}/Chart.lock"

        # Update Chart.yaml: change chart name and dependency name
        sed -i "s/^name: platform-apis$/name: ${NEW_MODULE}/" "${MODULE_DIR}/Chart.yaml"
        sed -i "s/^  - name: platform-apis$/  - name: ${NEW_MODULE}/" "${MODULE_DIR}/Chart.yaml"

        # Extract, rename, and repackage the dependency
        mkdir -p /tmp/chart-work
        tar -xzf "${MODULE_DIR}/charts/"*.tgz -C /tmp/chart-work

        # Rename chart name inside package
        sed -i "s/^name: platform-apis$/name: ${NEW_MODULE}/" /tmp/chart-work/platform-apis/Chart.yaml

        # Add suffix to resource names in templates
        for tpl in /tmp/chart-work/platform-apis/templates/*.yaml; do
          sed -i "s/name: platform-apis/name: ${NEW_MODULE}/g" "$tpl"
        done

        # Rename directory and repackage
        mv /tmp/chart-work/platform-apis "/tmp/chart-work/${NEW_MODULE}"
        rm -rf "${MODULE_DIR}/charts"
        mkdir -p "${MODULE_DIR}/charts"
        tar -czf "${MODULE_DIR}/charts/${NEW_MODULE}-${VERSION}.tgz" -C /tmp/chart-work "${NEW_MODULE}/"

        # Update values.yaml key
        [[ -s "${MODULE_DIR}/values.yaml" ]] && \
          sed -i "s/^platform-apis:/platform-apis-${SUFFIX}:/" "${MODULE_DIR}/values.yaml"

        # Update test configs
        for cfg in ${MODULE_DIR}/test/aws_*.yaml; do
          sed -i "s/^platform-apis:/platform-apis-${SUFFIX}:/" "$cfg"
        done

        rm -rf /tmp/chart-work
        echo "Created test module: ${MODULE_DIR}"

    - name: Run tests
      env:
        PR_BRANCH: ${{ github.head_ref || github.ref_name }}
        ENTIGO_INFRALIB_DESTROY: true
      run: ${MODULE_DIR}/test.sh

    - name: Cleanup
      if: always()
      run: |
        [[ -z "${SUFFIX}" ]] && echo "SUFFIX not set, skipping cleanup" && exit 0

        echo "Cleaning up all resources containing suffix: ${SUFFIX}"

        for cluster in pri-infra-eks biz-infra-eks; do
          aws eks update-kubeconfig --region $AWS_REGION --name $cluster 2>/dev/null || continue
          echo "Connected to $cluster"

          # Delete ArgoCD applications containing suffix
          for ns in argocd-pri argocd-biz; do
            echo "Checking ArgoCD apps in $ns..."
            kubectl get applications -n $ns -o name 2>/dev/null | grep -F "${SUFFIX}" | while read app; do
              echo "Deleting $app"
              kubectl delete $app -n $ns --wait=false 2>/dev/null || true
            done
          done

          # Delete Helm releases containing suffix
          echo "Checking Helm releases..."
          for ns in $(kubectl get ns -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            helm list -n $ns -q 2>/dev/null | grep -F "${SUFFIX}" | while read release; do
              echo "Uninstalling Helm release: $release in $ns"
              helm uninstall $release -n $ns 2>/dev/null || true
            done
          done

          # Delete namespaces containing suffix
          echo "Checking namespaces..."
          kubectl get ns -o name 2>/dev/null | grep -F "${SUFFIX}" | while read ns; do
            echo "Deleting $ns"
            kubectl delete $ns --wait=false 2>/dev/null || true
          done
        done

        # Cleanup local module directory
        [[ -n "${MODULE_DIR}" ]] && rm -rf "${MODULE_DIR}"
        echo "Cleanup completed"
