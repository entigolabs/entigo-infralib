name: Platform APIs RC Test

on:
  push:
    branches:
      - platform-apis-tests
    paths:
      - 'modules/k8s/platform-apis/**'
  pull_request:
    paths:
      - 'modules/k8s/platform-apis/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  test_platform_apis_rc:
    name: Test Platform APIs RC
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Helm
      uses: azure/setup-helm@v3

    - name: Setup RC test module
      id: setup
      run: |
        set -e

        # Find RC package
        RC_PKG=$(ls modules/k8s/platform-apis/charts/platform-apis-*.tgz 2>/dev/null | head -1)
        [[ -z "$RC_PKG" ]] && echo "No RC package found" && exit 1

        # Extract version and create suffix (e.g., 0.1.353-rc.31aa57c -> rc-31aa57c)
        VERSION=$(basename "$RC_PKG" .tgz | sed 's/platform-apis-//')
        SUFFIX=$(echo "$VERSION" | grep -oE 'rc\.[a-z0-9]+' | tr '.' '-')
        [[ -z "$SUFFIX" ]] && SUFFIX="rc-test"

        CHART_NAME="platform-apis-${SUFFIX}"
        MODULE_DIR="modules/k8s/${CHART_NAME}"

        echo "VERSION=$VERSION CHART_NAME=$CHART_NAME MODULE_DIR=$MODULE_DIR"

        # Extract and rename chart
        mkdir -p /tmp/chart-work
        tar -xzf "$RC_PKG" -C /tmp/chart-work
        mv /tmp/chart-work/platform-apis "/tmp/chart-work/${CHART_NAME}"
        sed -i "s/^name: platform-apis$/name: ${CHART_NAME}/" "/tmp/chart-work/${CHART_NAME}/Chart.yaml"
        tar -czf "/tmp/chart-work/${CHART_NAME}-${VERSION}.tgz" -C /tmp/chart-work "${CHART_NAME}/"

        # Create test module (clean slate)
        cp -r modules/k8s/platform-apis "$MODULE_DIR"
        rm -f "${MODULE_DIR}/Chart.lock"
        rm -rf "${MODULE_DIR}/charts"
        mkdir -p "${MODULE_DIR}/charts"
        cp "/tmp/chart-work/${CHART_NAME}-${VERSION}.tgz" "${MODULE_DIR}/charts/"

        # Generate Chart.yaml
        cat > "${MODULE_DIR}/Chart.yaml" << EOF
        apiVersion: v2
        name: ${CHART_NAME}
        description: Platform APIs RC Test
        version: ${VERSION}
        appVersion: "${VERSION}"
        dependencies:
          - name: ${CHART_NAME}
            version: ${VERSION}
            repository: "file://charts"
        EOF
        sed -i 's/^        //' "${MODULE_DIR}/Chart.yaml"

        # Update values references
        [[ -f "${MODULE_DIR}/values.yaml" ]] && sed -i "s/^platform-apis:/${CHART_NAME}:/" "${MODULE_DIR}/values.yaml"
        for cfg in ${MODULE_DIR}/test/aws_*.yaml; do
          echo "${CHART_NAME}: {}" > "$cfg"
        done

        # Build dependencies
        helm dependency update "${MODULE_DIR}"

        # Export for other steps
        echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV
        echo "CHART_NAME=${CHART_NAME}" >> $GITHUB_ENV
        echo "MODULE_DIR=${MODULE_DIR}" >> $GITHUB_ENV

    - name: Run tests
      env:
        PR_BRANCH: ${{ github.head_ref || github.ref_name }}
        ENTIGO_INFRALIB_DESTROY: true
      run: ${MODULE_DIR}/test.sh

#    - name: Cleanup
#      if: always()
#      run: |
#        # Skip cleanup if SUFFIX is not set
#        if [[ -z "${SUFFIX}" ]]; then
#          echo "Skipping cleanup: SUFFIX not set"
#          exit 0
#        fi
#
#        echo "Cleaning up resources with suffix: ${SUFFIX}"
#
#        for cluster in pri-infra-eks biz-infra-eks; do
#          aws eks update-kubeconfig --region $AWS_REGION --name $cluster 2>/dev/null || continue
#          echo "Connected to $cluster"

#          # Delete ArgoCD apps with suffix
#          for ns in argocd-pri argocd-biz; do
#            kubectl get applications -n $ns -o name 2>/dev/null | grep -F "${SUFFIX}" | \
#              xargs -r kubectl delete -n $ns --wait=false 2>/dev/null || true
#          done

#          # Delete namespaces with suffix
#          kubectl get ns -o name 2>/dev/null | grep -F "${SUFFIX}" | \
#            xargs -r kubectl delete --wait=false 2>/dev/null || true

#          # Delete Helm releases with suffix
#          for ns in $(kubectl get ns -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
#            helm list -n $ns -q 2>/dev/null | grep -F "${SUFFIX}" | \
#              xargs -r -I{} helm uninstall {} -n $ns 2>/dev/null || true
#          done
#        done

#        # Cleanup local files
#        [[ -n "${MODULE_DIR}" ]] && rm -rf "${MODULE_DIR}"
#        rm -rf /tmp/chart-work

#        echo "Cleanup completed"