alloy:
  alloy:
    priorityClassName: "{{ .module.name }}"
    configMap:
      content: |
        logging {
          level  = "warn"
          format = "json"
        }

        # Discover pods from Kubernetes API
        discovery.kubernetes "pod" {
          role = "pod"
          selectors {
            role  = "pod"
            field = "spec.nodeName=" + env("HOSTNAME")
          }
        }

        # Extract labels from Kubernetes metadata (matches Promtail defaults)
        discovery.relabel "pod_logs" {
          targets = discovery.kubernetes.pod.targets

          # Extract controller name for app label fallback
          rule {
            source_labels = ["__meta_kubernetes_pod_controller_name"]
            regex         = "([0-9a-z-.]+?)(-[0-9a-f]{8,10})?"
            target_label  = "__tmp_controller_name"
          }

          # app label: app.kubernetes.io/name -> app -> controller name -> pod name
          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name", "__meta_kubernetes_pod_label_app", "__tmp_controller_name", "__meta_kubernetes_pod_name"]
            regex         = "^;*([^;]+)(;.*)?$"
            target_label  = "app"
          }

          # instance label: app.kubernetes.io/instance -> instance
          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_instance", "__meta_kubernetes_pod_label_instance"]
            regex         = "^;*([^;]+)(;.*)?$"
            target_label  = "instance"
          }

          # component label: app.kubernetes.io/component -> component
          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_component", "__meta_kubernetes_pod_label_component"]
            regex         = "^;*([^;]+)(;.*)?$"
            target_label  = "component"
          }

          # node_name label
          rule {
            source_labels = ["__meta_kubernetes_pod_node_name"]
            target_label  = "node_name"
          }

          # namespace label
          rule {
            source_labels = ["__meta_kubernetes_namespace"]
            target_label  = "namespace"
          }

          # job label: namespace/app
          rule {
            source_labels = ["namespace", "app"]
            separator     = "/"
            target_label  = "job"
          }

          # pod label
          rule {
            source_labels = ["__meta_kubernetes_pod_name"]
            target_label  = "pod"
          }

          # container label
          rule {
            source_labels = ["__meta_kubernetes_pod_container_name"]
            target_label  = "container"
          }

          # __path__ for regular pods
          rule {
            source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
            separator     = "/"
            target_label  = "__path__"
            replacement   = "/var/log/pods/*$1/*.log"
          }

          # __path__ override for static pods (kube-system)
          rule {
            source_labels = ["__meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash", "__meta_kubernetes_pod_annotation_kubernetes_io_config_hash", "__meta_kubernetes_pod_container_name"]
            regex         = "true/(.*)"
            separator     = "/"
            target_label  = "__path__"
            replacement   = "/var/log/pods/*$1/*.log"
          }
        }

        # Tail logs from disk
        loki.source.file "pod_logs" {
          targets       = discovery.relabel.pod_logs.output
          forward_to    = [loki.process.pod_logs.receiver]
          tail_from_end = true
        }

        # Process logs
        loki.process "pod_logs" {
          # Parse CRI format (containerd/cri-o)
          stage.cri {}
          forward_to = [loki.write.default.receiver]
        }

        # Send to Loki
        loki.write "default" {
          endpoint {
            url = "http://{{ .tmodule.loki }}-gateway.{{ .tmodule.loki }}/loki/api/v1/push"
          }
        }
